
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Leukocyte Identification</title><meta name="generator" content="MATLAB 8.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-04-02"><meta name="DC.source" content="main.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Leukocyte Identification</h1><!--introduction--><p>Leukocyte (White Blood Cell) Identification MATLAB scripts</p><p>ECSE 4540 - Introduction to Image Processing Final Project Mitchell Phillips, 661060944</p><p>Last Updated: April 2, 2017</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Notes</a></li><li><a href="#3">test001.jpg</a></li><li><a href="#16">References</a></li></ul></div><h2>Notes<a name="1"></a></h2><p>Currently in development. Using single image to perform preliminary identification algorithums.</p><pre class="codeinput">clc, clear, close <span class="string">all</span>;
warning <span class="string">off</span>;

<span class="comment">% import image(s)</span>
addpath(genpath(<span class="string">'images/'</span>)); <span class="comment">% edit as needed</span>
</pre><h2>test001.jpg<a name="3"></a></h2><p>Preliminary Analysis</p><pre class="codeinput"><span class="comment">% import test image</span>
im = imread(<span class="string">'test001.jpg'</span>);

<span class="comment">% display test image</span>
figure(1);
imshow(im);
</pre><img vspace="5" hspace="5" src="main_01.png" alt=""> <p>Figure 1 was the test image for identifying Leukocytes. In the image, there are 6 large purple blobs. These are the white blood cells; however, not all of these cells are the same. There are five different types of white blood cells, each of which can be distinguished based on their appearance: (1.) Neutrophils, (2.) Lymphocytes, (3.) Monocytes, (4.) Eosinophils, and (5.) Basophils. (Note: each type is indicated on the figure above.) Neutrophils can be identified by their pinched-in nucleus (darker purple region) which may have a horseshoe-like appearence. Lymphocytes contain a large, generally round and uniform nuclues. Monocytes are distinguish from their large nuclues, similar to that of Lymphocytes, except they contain more cytoplasm (the light purple surounding the nucleus. Eosinphils are similar to Neutrophils in appearance, with large granules (small dark purple dots) in the cytoplasm. Basophils are the easiest to distinguish as they are characterized by large, dark purple granules. These five types of Leukocytes can be split into two distinct groups based on the granules;</p><p>1.) Granulocytes - Basophil, Eosinophil, and Neutrophil</p><p>2.) Agranulocytes - Lymphocytes and Monocytes</p><p>Reference: [1]</p><p>After inital viewing of the test image, the grayscale and each of the RGB channels were investigated.</p><pre class="codeinput">imgray = rgb2gray(im); <span class="comment">% grayscale image</span>
R = im(:,:,1); <span class="comment">% red channel</span>
G = im(:,:,2); <span class="comment">% green channel</span>
B = im(:,:,3); <span class="comment">% blue channel</span>

figure(2)
subplot(2,2,1), imshow(imgray)
title(<span class="string">'Grayscale'</span>)
subplot(2,2,2), imshow(R)
title(<span class="string">'Red Channel'</span>)
subplot(2,2,3), imshow(G)
title(<span class="string">'Green Channel'</span>)
subplot(2,2,4), imshow(B)
title(<span class="string">'Blue Channel'</span>)
</pre><img vspace="5" hspace="5" src="main_02.png" alt=""> <p>Figure 2 contains the grayscale, red, green, and blue channels, of the image shown in figure 1. It is observered that the in the test image, the Leukocytes contain large intensities in the blue channel, however that is true of most of the image. This is indicated by the fact that the majority of the image is made up of lighter shades. Conversely, in the greyscale, red, and green channels, the Leukocytes are characterized by lower intensity values. The intensitivity behavior can be attributed to violet color of the Leukocytes from the original image. It is noted that the dark characterization however is only true for the nucleui, not the cytoplasm.</p><p>Using a similar process as Prinyakupt and Pluempitiwiriyawej [2], nucleus segmentation was first performed by averaging the red and blue channel intensites. This was done because the the green channel contains the lowest pixel intensities of the nuclues (as indicated in figure 2). Results are shown below,</p><pre class="codeinput">nucl = histeq((R+B)./(2.*G));

figure(3);
imshow(nucl)
</pre><img vspace="5" hspace="5" src="main_03.png" alt=""> <p>Figure 3 is the histogram equalized image of figure 1. Based on the image above, the nucleui of each of the Leukocytes can be distinguished. This was perform by first inspecting the histogram levels after equalization, thresholding the image appropriatly, and applying morphalogical transformations to fill in any gaps that may occur.</p><pre class="codeinput">figure(4);
imhist(nucl);
</pre><img vspace="5" hspace="5" src="main_04.png" alt=""> <p>Figure 4 is the histogram corresponding to figure 3. Based on the obtained values, a threshold of pixel intensity of 150 will be used. Results are shown below.</p><pre class="codeinput">level = 150;
nuclBW = nucl &gt; level;

figure(5);
imshow(nuclBW);
</pre><img vspace="5" hspace="5" src="main_05.png" alt=""> <p>Figure 5 is the binary image from figure 3 after thresholding. From inspection, all 6 Leukocytes remain. However, there are several holes and undesired elements in the figure. To improve the image and accomadate the identification algorithum, the morphalogical transformations were performed.</p><pre class="codeinput">sqOpen = strel(<span class="string">'disk'</span>,2);
nuclMorph = imopen(nuclBW,sqOpen);
sqClose = strel(<span class="string">'disk'</span>,3);
nuclMorph = imclose(nuclMorph,sqClose);

figure(6);
imshow(nuclMorph);
</pre><img vspace="5" hspace="5" src="main_06.png" alt=""> <p>Figure 6 is the morphologoical processed image to remove both any unwanted small objects as well as remove any small holes from the nucleui, hence both the opening and closeing processes. Using the binary image from figure 6, the Leukocytes can be identified using the nucleui. This is demomstrated below using the created function <tt>wbcNuclei.m</tt></p><pre class="codeinput">wbcNuclei(im, 7)
</pre><img vspace="5" hspace="5" src="main_07.png" alt=""> <p>Figure 7 is the original image with any Leukocytes marked and identified. Using these results, the entire process of splitting the color channels averaging the levels, histogram equalization, thresholding, and morphological processing was placed into a single function, <tt>wbcNuclei.m</tt> that can detect Leukocytes based on the nuclei stain.</p><p>The effectivness of <tt>wbcNuclei.m</tt> for Leukocyte identification is demonstrated below using a series of images. Each test image was inspected aftwards to evaluate if all Leukocytes have been accounted for.</p><pre class="codeinput">imN1 = imread(<span class="string">'4303059.jpg'</span>);
wbcNuclei(imN1, 8);
imN2 = imread(<span class="string">'4303041.jpg'</span>);
wbcNuclei(imN2, 9);
imN3 = imread(<span class="string">'4303101.jpg'</span>);
wbcNuclei(imN3, 10);
imN4 = imread(<span class="string">'4304032.jpg'</span>);
wbcNuclei(imN4, 11);
</pre><img vspace="5" hspace="5" src="main_08.png" alt=""> <img vspace="5" hspace="5" src="main_09.png" alt=""> <img vspace="5" hspace="5" src="main_10.png" alt=""> <img vspace="5" hspace="5" src="main_11.png" alt=""> <p>Figures 8 through 11 demonstrate the capabilities of the created <tt>wbcNuclei.m</tt> function. Based on the above results, it is observed that the identification works well for most images. However, the identification in figure 11 is rather poor. From inspection, it is clear that there is one Leukocyte in the center of the image with another cut off on the right-hand side. Results over estimated the number of leukocytes. Errors in figure 11 were investigated further.</p><pre class="codeinput">wbcNuclei(imN4, 12);
</pre><img vspace="5" hspace="5" src="main_12.png" alt=""> <p>After debugging the function, it was determined to increase the morphological structuring element size for closing the image from 3 to 15. Doing so increased the size of any holes that may form in the binary image, causing inaccuracies when counting.</p><h2>References<a name="16"></a></h2><p>[1]: <a href="http://www.pathologystudent.com/?p=4776">http://www.pathologystudent.com/?p=4776</a></p><p>[2]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4485641/pdf/12938_2015_Article_37.pdf</p><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Leukocyte Identification
% Leukocyte (White Blood Cell) Identification MATLAB scripts
%
% ECSE 4540 - Introduction to Image Processing Final Project
% Mitchell Phillips, 661060944
%
% Last Updated: April 2, 2017
%

%% Notes
%
% Currently in development. Using single image to perform preliminary
% identification algorithums.
%

%%

clc, clear, close all;
warning off;

% import image(s)
addpath(genpath('images/')); % edit as needed

%% test001.jpg
%
% Preliminary Analysis
%

% import test image
im = imread('test001.jpg');

% display test image
figure(1);
imshow(im);

%%
%
% Figure 1 was the test image for identifying Leukocytes. In the image, 
% there are 6 large purple blobs. These are the white blood cells; however,
% not all of these cells are the same. There are five different types of 
% white blood cells, each of which can be distinguished based on their 
% appearance: (1.) Neutrophils, (2.) Lymphocytes, (3.) Monocytes, 
% (4.) Eosinophils, and (5.) Basophils. (Note: each type is indicated on 
% the figure above.) Neutrophils can be identified by their pinched-in 
% nucleus (darker purple region) which may have a horseshoe-like 
% appearence. Lymphocytes contain a large, generally round and uniform 
% nuclues. Monocytes are distinguish from their large nuclues, similar to 
% that of Lymphocytes, except they contain more cytoplasm (the light purple
% surounding the nucleus. Eosinphils are similar to Neutrophils in 
% appearance, with large granules (small dark purple dots) in the 
% cytoplasm. Basophils are the easiest to distinguish as they are
% characterized by large, dark purple granules. These five types of
% Leukocytes can be split into two distinct groups based on the granules; 
%
% 1.) Granulocytes - Basophil, Eosinophil, and Neutrophil
%
% 2.) Agranulocytes - Lymphocytes and Monocytes
%
% Reference: [1]
%

%%
%
% After inital viewing of the test image, the grayscale and each of the RGB
% channels were investigated. 
%

imgray = rgb2gray(im); % grayscale image
R = im(:,:,1); % red channel
G = im(:,:,2); % green channel
B = im(:,:,3); % blue channel

figure(2)
subplot(2,2,1), imshow(imgray)
title('Grayscale')
subplot(2,2,2), imshow(R)
title('Red Channel')
subplot(2,2,3), imshow(G)
title('Green Channel')
subplot(2,2,4), imshow(B)
title('Blue Channel')

%%
%
% Figure 2 contains the grayscale, red, green, and blue channels, of the
% image shown in figure 1. It is observered that the in the test image, the
% Leukocytes contain large intensities in the blue channel, however that is
% true of most of the image. This is indicated by the fact that the
% majority of the image is made up of lighter shades. Conversely, in the
% greyscale, red, and green channels, the Leukocytes are characterized by
% lower intensity values. The intensitivity behavior can be attributed to 
% violet color of the Leukocytes from the original image. It is noted that 
% the dark characterization however is only true for the nucleui, not the 
% cytoplasm. 


%%
%
% Using a similar process as Prinyakupt and Pluempitiwiriyawej [2],
% nucleus segmentation was first performed by averaging the red and blue
% channel intensites. This was done because the the green channel contains
% the lowest pixel intensities of the nuclues (as indicated in figure 2).
% Results are shown below,
%

nucl = histeq((R+B)./(2.*G));

figure(3);
imshow(nucl)

%%
%
% Figure 3 is the histogram equalized image of figure 1. Based on the
% image above, the nucleui of each of the Leukocytes can be distinguished.
% This was perform by first inspecting the histogram levels after
% equalization, thresholding the image appropriatly, and
% applying morphalogical transformations to fill in any gaps that may
% occur.
%

figure(4);
imhist(nucl);

%%
%
% Figure 4 is the histogram corresponding to figure 3. Based on the
% obtained values, a threshold of pixel intensity of 150 will be used.
% Results are shown below.
%

level = 150;
nuclBW = nucl > level;

figure(5);
imshow(nuclBW);

%%
%
% Figure 5 is the binary image from figure 3 after thresholding. From
% inspection, all 6 Leukocytes remain. However, there are several holes and
% undesired elements in the figure. To improve the image and accomadate the
% identification algorithum, the morphalogical transformations were
% performed. 
%

sqOpen = strel('disk',2);
nuclMorph = imopen(nuclBW,sqOpen);
sqClose = strel('disk',3);
nuclMorph = imclose(nuclMorph,sqClose);

figure(6);
imshow(nuclMorph);

%%
%
% Figure 6 is the morphologoical processed image to remove both any
% unwanted small objects as well as remove any small holes from the
% nucleui, hence both the opening and closeing processes. Using the binary
% image from figure 6, the Leukocytes can be identified using the nucleui.
% This is demomstrated below using the created function |wbcNuclei.m|
%

wbcNuclei(im, 7)

%%
%
% Figure 7 is the original image with any Leukocytes marked and identified.
% Using these results, the entire process of splitting the color channels
% averaging the levels, histogram equalization, thresholding, and
% morphological processing was placed into a single function, |wbcNuclei.m|
% that can detect Leukocytes based on the nuclei stain. 
%

%% 
%
% The effectivness of |wbcNuclei.m| for Leukocyte identification is
% demonstrated below using a series of images. Each test image was
% inspected aftwards to evaluate if all Leukocytes have been accounted for.
% 


imN1 = imread('4303059.jpg');
wbcNuclei(imN1, 8);
imN2 = imread('4303041.jpg');
wbcNuclei(imN2, 9);
imN3 = imread('4303101.jpg');
wbcNuclei(imN3, 10);
imN4 = imread('4304032.jpg');
wbcNuclei(imN4, 11);

%%
%
% Figures 8 through 11 demonstrate the capabilities of the
% created |wbcNuclei.m| function. Based on the above results, it is
% observed that the identification works well for most images. However,
% the identification in figure 11 is rather poor. From inspection, it is
% clear that there is one Leukocyte in the center of the image with another
% cut off on the right-hand side. Results over estimated the number of
% leukocytes. Errors in figure 11 were investigated further.
%

wbcNuclei(imN4, 12);

%%
%
% After debugging the function, it was determined to increase the 
% morphological structuring element size for closing the image from 3 to
% 15. Doing so increased the size of any holes that may form in the binary
% image, causing inaccuracies when counting. 
%

%% References
%
% [1]: http://www.pathologystudent.com/?p=4776
%
% [2]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4485641/pdf/12938_2015_Article_37.pdf
%

##### SOURCE END #####
--></body></html>